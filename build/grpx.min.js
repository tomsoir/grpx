/*
    GRPX lib (https://github.com/tomsoir/grpx)
    Correct Price (http://correctprice.ru/)
    version 0.1.1
    date 2015-02-28
*/
(function(){!function(a,b){"object"==typeof exports?b(exports,require("jQuery")):"function"==typeof define&&define.amd?define(["exports","jQuery"],b):b(window,$)}(this,function(a,b){var c;return a.GRPX=c=function(){function a(a){this._applyOptions(a),this._requiresReady()}return a.prototype.config={desc:void 0,sect:void 0,masterApi:"api.correctprice.ru",backupApi:"api2.correctprice.ru",developApi:"api-dev.correctprice.ru"},a.prototype._getProtocol=function(){return"https:"!==window.location.protocol?"http://":"https://"},a.prototype._applyOptions=function(a){return(null!=a?a.dev:void 0)?this.config.masterApi=this.config.developApi:void 0},a.prototype._sendRequest=function(a,c){var d,e;return e=b.Deferred(),d=c?"1":"",b.ajax({url:this._getProtocol()+this.config.masterApi+"/"+a+"?"+d+"jsoncallback=?",dataType:"json",timeout:3e3,success:function(){return function(a){return e.resolve(a)}}(this),error:function(a){return function(){return a.config.masterApi=a.config.backupApi,a._requiresReady()}}(this)}),e},a.prototype._requiresReady=function(){return b(function(a){return function(){var c,d;return d=b.Deferred(),a.config.desc||a.config.sect?d.resolve():(c=function(){return a.config.desc&&a.config.sect?d.resolve():void 0},a._sendRequest("get_opt_desc").done(function(b){return a.config.desc=b,c()}),a._sendRequest("get_opt_sect").done(function(b){return a.config.sect=b,c()})),d}}(this))},a.prototype.unpack=function(a){var c,d,e,f,g,h;return f=this.config.desc,g=this.config.sect,d=a,h={},c=[],e="",b(g).each(function(a,b){var d,f,g,i;if(h[b.catg]=b.sect,e!==b.sect){for(e=b.sect,d=!1,g=0,i=c.length;i>g;g++)f=c[g],f===e&&(d=!0);if(!d)return c.push(e)}}),b(d).each(function(a,c){return c.options={},b(f).each(function(a,b){var d,e,f;return e=c["grp"+b.grp],d=Math.ceil(e.length-b.pos/4-1),parseInt("0x"+e.substring(d,d+1))&Math.pow(2,b.pos%4)?(f=h[b.catg],void 0===c.options[f]&&(c.options[f]={}),void 0===c.options[f][b.catg]?c.options[f][b.catg]=b.name:c.options[f][b.catg]instanceof Array?c.options[f][b.catg].push(b.name):c.options[f][b.catg]=[c.options[f][b.catg],b.name]):void 0})}),d.options},a.prototype.pack=function(a){var c,d,e,f,g,h;return e=this.config.desc,f=this.config.sect,d={},c=[[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0]],b(e).each(function(b,d){return"undefined"!=typeof a[d.catg]&&a[d.catg]===d.name?c[d.grp][d.pos>31?1:0]+=Math.pow(2,d.pos>31?d.pos-32:d.pos):void 0}),h=function(a){for(;a.length>1&&"0"===a.substr(0,1);)a=a.substr(1);return a},b(c).each(function(a,b){return b[1]=h(b[1].toString(16)+("00000000"+b[0].toString(16)).substr(-8)),b[0]="grp"+a}),g="grp0="+c[0][1]+"&grp1="+c[1][1]+"&grp2="+c[2][1]+"&grp3="+c[3][1]+"&grp4="+c[4][1]+"&grp5="+c[5][1]+"&grp6="+c[6][1]+"&grp7="+c[7][1],d.url=g,d.obj={grp0:c[0][1],grp1:c[1][1],grp2:c[2][1],grp3:c[3][1],grp4:c[4][1],grp5:c[5][1],grp6:c[6][1],grp7:c[7][1]},d},a.prototype.unpackToDefault=function(a){var b,c,d,e;e={},b=this.unpack(a);for(c in b)for(d in b[c])e[d]=b[c][d][0];return e},a.prototype.extendIncomingToDefault=function(a,b){var c;for(c in b)a[c]?a[c]=b[c]:console.error("Can't find param with name: "+c);return a},a.prototype.packWithDefault=function(a,b){var c,d,e;return c=this.unpackToDefault(b),e=this.extendIncomingToDefault(c,a),d=this.pack(e)},a}()})}).call(this);