/*
    GRPX lib (https://github.com/tomsoir/grpx)
    Correct Price (http://correctprice.ru/)
    version 0.1.1
    date 2015-03-04
*/
!function(a,b){"object"==typeof exports?b(exports,require("jQuery")):"function"==typeof define&&define.amd?define(["exports","jQuery"],b):b(window,$)}(this,function(a,b){var c,d,e;return e={_getImageSrc:function(a,b){return"no"===String(a)?b+"/f/1/global/b/b-calculations/noimg.jpeg":b+"/r/"+a+"/1.jpg"},_formatPriceMatrix:function(a,b){var c,d,e,f,g,h,i,j,k;for(g=this.textsModule,f={selectedConditionStr:g[b],selectedCondition:b,groupCondition:{},selectedConditionGroup:{},otherConditionHeads:[],otherConditionGroup:[]},h=0,j=a.length;j>h;h++)e=a[h],f.groupCondition[e.cond]={way:{},name:e.cond,title:g[e.cond],selected:String(b)===String(e.cond)?!0:!1};for(i=0,k=a.length;k>i;i++)e=a[i],f.groupCondition[e.cond].way[e.way]=e.price;for(d in f.groupCondition)c=f.groupCondition[d],c.selected&&(f.selectedConditionGroup=c);for(d in f.groupCondition)c=f.groupCondition[d],c.selected||(f.otherConditionGroup.push(c),f.otherConditionHeads.push({name:c.name,title:c.title}));return f},_monthText:function(a){var b;switch(String(a)){case"1":b="Январь";break;case"2":b="Февраль";break;case"3":b="Март";break;case"4":b="Апрель";break;case"5":b="Май";break;case"6":b="Июнь";break;case"7":b="Июль";break;case"8":b="Август";break;case"9":b="Сентябрь";break;case"10":b="Октябрь";break;case"11":b="Ноябрь";break;case"12":b="Декабрь"}return b},_returnParam:function(a){return a?a:void 0},_getModifyByText:function(a){var b,c,d,e,f,g,h;for(f=this.textsModule,c=[],b=String(a).split("_"),g=0,h=b.length;h>g;g++)e=b[g],c.push(f[String(e).toLowerCase()]?f[String(e).toLowerCase()]:e);return d={},b=String(a).split("_"),{asArray:c,asGroup:{body:{title:f.body,value:f[String(b[0]).toLowerCase()]},engine_volume:{title:f.engine_volume,value:String(b[1]).replace(/^(.*)\(.*\)$/,"$1")},power:{title:f.power,value:String(b[1]).replace(/^.*\((.*)\)$/,"$1")},engine_type:{title:f.engine_type,value:b[2]},privod:{title:f.privod,value:b[3]},transmission:{title:f.transmission,value:b[4]}}}},_getBrandIconByMark:function(a,b,c){var d,e,f,g,h;for(e=String(a).toLowerCase().trim().replace(/(.+)\s.*/g,"$1"),h=b.brands,f=0,g=h.length;g>f;f++)d=h[f],d.id===e&&(b=d);return b?c+"/r/"+String(b.uuid).trim()+"/icon_"+String(b.file_name).trim():c+"/r/63806594-6C1E-4C56-BC4B-0E911E967BD4/icon_noimg.jpeg"},textsModule:{appType:{1:"справочник",2:"trade-In",3:"trade-In отправки заявки",4:"разработка внутри компании"},reportType:{1:"все расчеты и заявки",2:"партнерская статистика"},"внедорожник 3 door":"Внедорожник 3-х дверный","внедорожник 3 door (new)":"Внедорожник 3-х дверный (обновленный)","внедорожник 5 door":"Внедорожник 5-и дверный","внедорожник 5 door (new)":"Внедорожник 5-и дверный (обновленный)","кабриолет":"Кабриолет","кабриолет (new)":"Кабриолет (обновленный)","купе":"Купе","купе (new)":"Купе (обновленный)","минивэн":"Минивэн","минивэн (new)":"Минивэн (обновленный)","пикап":"Пикап","пикап (new)":"Пикап (обновленный)","родстер":"Родстер","родстер (new)":"Родстер (обновленный)","седан":"Седан","седан (new)":"Седан (обновленный)","универсал":"Универсал","универсал (new)":"Универсал (обновленный)","хэтчбек 3 door":"Хэтчбек 3-х дверный","хэтчбек 3 door (new)":"Хэтчбек 3-х дверный (обновленный)","хэтчбек 5 door":"Хэтчбек 5-и дверный","хэтчбек 5 door (new)":"Хэтчбек 5-и дверный (обновленный)",userGuidText:"Мы сохраняем 10 последних сделанных вами расчетов.",headerSubText:"Возможности вашего личного кабинета могут быть увеличены.",yes:"Да",no:"Нет",normal:"Нормальное",good:"Хорошее",excellent:"Превосходное",owners:"Владелец",color:"Цвет кузова",ckeys:"Количество ключей",condition:"Состояние автомобиля",genuine_docs:"Наличие документов",s_color:"Цвет салона",sbook:"Наличие сервисной книжки",aerography:"Аэрография",body:"Кузов",engine_volume:"Объем двигателя",power:"Мощность",engine_type:"Тип двигателя",privod:"Привод",transmission:"Коробка передач"}},d=function(){function a(a,b){this.GRPX=a,this.staticHost=a.config.staticHost,this.options=b}return a.prototype.minimalOptions=["year","mid","cmid","agemonths","grp0","grp1","grp2","grp3","grp4","grp5","grp6","grp7","mileage","version"],a.prototype.model={details:void 0,price:void 0,brands:void 0},a.prototype.getData=function(){var a;return a=b.Deferred(),this._checkOptions(a)&&this.GRPX._onload(arguments,function(b){return function(){return b._getRequireData().done(function(){return a.resolve(b._prepareResultData())})}}(this)),a},a.prototype._getRequireData=function(){var a,c;return c=b.Deferred(),a=function(a){return function(){return a.model.details&&a.model.price&&a.model.brands?c.resolve():void 0}}(this),this.model.details||this._sendRequest("get_full_details").done(function(b){return function(c){return b.model.details=c[0],a()}}(this)),this.model.price||this._sendRequest("get_calculation").done(function(b){return function(c){return b.model.price=c,a()}}(this)),this.model.brands||this._sendRequest("get_brands").done(function(b){return function(c){return b.model.brands=c,a()}}(this)),a(),c},a.prototype._sendRequest=function(a){var b;switch(a){case"get_full_details":return b=["year="+this.options.year,"mid="+this.options.mid,"cmid="+this.options.cmid,"version="+this.options.version],this.GRPX.createRequest("get_full_details",b.join("&")+"&");case"get_calculation":return b=["year="+this.options.year,"mid="+this.options.mid,"cmid="+this.options.cmid,"version="+this.options.version,"agemonths="+this.options.agemonths,"mileage="+this.options.mileage,"grp0="+this.options.grp0,"grp1="+this.options.grp1,"grp2="+this.options.grp2,"grp3="+this.options.grp3,"grp4="+this.options.grp4,"grp5="+this.options.grp5,"grp6="+this.options.grp6,"grp7="+this.options.grp7,"country="+(this.options.country?this.options.country:"RU"),"province="+(this.options.province?this.options.province:"47")],this.GRPX.createRequest("get_calculation",b.join("&")+"&");case"get_brands":return this.GRPX.createRequest("get_brands")}},a.prototype._checkOptions=function(a){var b,c,d,e,f;if(c=!1,this.options){for(f=this.minimalOptions,d=0,e=f.length;e>d;d++)b=f[d],"undefined"==typeof this.options[b]&&(c=!1);c=!0}return c||(console.error("minimal options missing: "+this.minimalOptions.join(", ")),a.reject()),c},a.prototype._prepareResultData=function(){var a;return a=null!=this.model.details.gallery?this.model.details.gallery:"no",{image:e._getImageSrc(a,this.staticHost),price:e._formatPriceMatrix(this.model.price.price,this.model.price.selected_condition),date:{yearProduction:this.options.year,yearRegistration:this.options.year,monthRegistration:1,monthRegistrationStr:e._monthText(1)},make:this.model.details.make,makeIcon:e._getBrandIconByMark(this.model.details.make,this.model,this.staticHost),model:this.model.details.model,modify:e._getModifyByText(this.model.details.mod_name),compllectation:{base:e._returnParam(this.model.details.compl_base_name),name:e._returnParam(this.model.details.compl_name),full:this.model.details.compl_base_name?this.model.details.compl_name+" ("+this.model.details.compl_base_name+")":this.model.details.compl_name},mileage:this.options.mileage,version:this.options.version,agemonths:this.options.agemonths,gallery:this.model.details.gallery}},a}(),c=function(){function a(){this._jqueryReady()&&this.requiresReady()}return a.prototype.ready=!1,a.prototype.desc=void 0,a.prototype.sect=void 0,a.prototype.config={staticHost:"http://correctprice.ru",masterApi:"http://api.correctprice.ru",backupApi:"http://api2.correctprice.ru"},a.prototype._jqueryReady=function(){return b.isReady?!0:(console.error("jQuery not ready. Placed this call into $(function{ ... })"),!1)},a.prototype.createRequest=function(a,c){var d;return d=b.Deferred(),c=c?c:"",b.ajax({url:this.config.masterApi+"/"+a+"?"+c+"jsoncallback=?",timeout:3e3,dataType:"json",success:function(){return function(a){return null!=a?d.resolve(a):void 0}}(this),error:function(b){return function(){return b.config.masterApi!==b.config.backupApi?(b.config.masterApi=b.config.backupApi,b.createRequest(a,c)):console.error("Error plugin Correct Price api service")}}(this)}),d},a.prototype.requiresReady=function(){var a;return this._readyState=b.Deferred(),this.desc||this.sect?this._readyState.resolve():(a=function(a){return function(){return a.desc&&a.sect?(a.ready=!0,a._readyState.resolve()):void 0}}(this),this.createRequest("get_opt_desc").done(function(b){return function(c){return b.desc=c,a()}}(this)),this.createRequest("get_opt_sect").done(function(b){return function(c){return b.sect=c,a()}}(this))),this._readyState},a.prototype._onload=function(a,c){var d,e;return this._jqueryReady()?(d=this,e=b.Deferred(),this._readyState.done(function(){var b;return b=c.apply(d,a),e.resolve(b)}),e):{done:function(){return!1}}},a.prototype.pack=function(){return this._onload(arguments,this._pack)},a.prototype._pack=function(a){var c,d,e,f,g,h;return e=this.desc,f=this.sect,d={},c=[[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0]],b(e).each(function(b,d){return"undefined"!=typeof a[d.catg]&&a[d.catg]===d.name?c[d.grp][d.pos>31?1:0]+=Math.pow(2,d.pos>31?d.pos-32:d.pos):void 0}),h=function(a){for(;a.length>1&&"0"===a.substr(0,1);)a=a.substr(1);return a},b(c).each(function(a,b){return b[1]=h(b[1].toString(16)+("00000000"+b[0].toString(16)).substr(-8)),b[0]="grp"+a}),g="grp0="+c[0][1]+"&grp1="+c[1][1]+"&grp2="+c[2][1]+"&grp3="+c[3][1]+"&grp4="+c[4][1]+"&grp5="+c[5][1]+"&grp6="+c[6][1]+"&grp7="+c[7][1],d.url=g,d.obj={grp0:c[0][1],grp1:c[1][1],grp2:c[2][1],grp3:c[3][1],grp4:c[4][1],grp5:c[5][1],grp6:c[6][1],grp7:c[7][1]},d},a.prototype.unpack=function(){return this._onload(arguments,this._unpack)},a.prototype._unpack=function(a){var c,d,e,f,g,h;return f=this.desc,g=this.sect,d=a,h={},c=[],e="",b(g).each(function(a,b){var d,f,g,i;if(h[b.catg]=b.sect,e!==b.sect){for(e=b.sect,d=!1,g=0,i=c.length;i>g;g++)f=c[g],f===e&&(d=!0);if(!d)return c.push(e)}}),b(d).each(function(a,c){return c.options={},b(f).each(function(a,b){var d,e,f;return e=c["grp"+b.grp],d=Math.ceil(e.length-b.pos/4-1),parseInt("0x"+e.substring(d,d+1))&Math.pow(2,b.pos%4)?(f=h[b.catg],void 0===c.options[f]&&(c.options[f]={}),void 0===c.options[f][b.catg]?c.options[f][b.catg]=b.name:c.options[f][b.catg]instanceof Array?c.options[f][b.catg].push(b.name):c.options[f][b.catg]=[c.options[f][b.catg],b.name]):void 0})}),d.options},a.prototype.unpackToDefault=function(){return this._onload(arguments,this._unpackToDefault)},a.prototype._unpackToDefault=function(a){var b,c,d,e;e={},b=this._unpack(a);for(c in b)for(d in b[c])e[d]=b[c][d][0];return e},a.prototype._extendIncomingToDefault=function(a,b){var c;for(c in b)a[c]?a[c]=b[c]:console.error("Can't find param with name: "+c);return a},a.prototype.packWithDefault=function(){return this._onload(arguments,this._packWithDefault)},a.prototype._packWithDefault=function(a,b){var c,d,e;return c=this._unpackToDefault(b),e=this._extendIncomingToDefault(c,a),d=this._pack(e)},a.prototype.getFullDetales=function(a){return null==this._printClass&&(this._printClass=new d(this,a)),this._printClass.getData()},a}(),a.$GRPX||(a.$GRPX=c),c});